---
title: "MSDS 6306 Case Study Two"
author: "Ryan Herrin"
date: "11/19/2021"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(stringr)
library(tidyverse)
library(tidymodels)
library(GGally)
library(plotly)
library(ggplot2)
library(plyr) # Load first before dplyer 
library(dplyr)
library(tidyr)
library(ggalt)
library(class)
library(caret)
library(e1071)
library(tm)
library(mvtnorm)
library(xlsx)
library(leaflet)
library(ggvis)
library(pracma)
library(kknn) # used by the nearest_neighbor engine
library(corrplot)
library(randomForest)
```

# Setup and read-in provided Data
```{r class.source = 'fold-show'}
# define locations within folder structure 
comp_set_loc <- "./StartingDBs/CaseStudy2-data.csv"
comp_set_no_attrition_loc <- "./StartingDBs/CaseStudy2CompSet-No-Attrition.csv"
comp_set_no_salary_loc <- "./StartingDBs/CaseStudy2CompSet-No-Salary.xlsx"

# Read-in data and create dataframes
comp_set <- read.csv(comp_set_loc, header = TRUE)
comp_set_no_attrition <- read.csv(comp_set_no_attrition_loc, header = TRUE)
comp_set_no_salary <- read.xlsx(file=comp_set_no_salary_loc, sheetIndex = 1, 
                                header=TRUE, stringsAsFactors = FALSE)
```

# Reusable Functions
```{r class.source = 'fold-show'}
# Create normalization function for continouse varibales
min_max_norm <- function(x) {(x - min(x)) / (max(x) - min(x))}

CategoryToPercent <- function(df) {
  # Function that will transform each catigorical value into percentages based on its relation to attrition
  # Uses the WOE method. **** Attrition Must be First Column ****
  df <- df
  
  for(col in 2:ncol(df)) {
    tmp_count <- count(df[col])
    colnames(tmp_count) <- c("x", "freq") # rename columns to make them standard
    
    for(val in 1:length(tmp_count$x)) {
      # Get number of rows that have the val with a Yes for attrition
      count_attrition <- nrow(filter(df, df[1]=="Yes" & df[col]==tmp_count$x[val]))
      # Calculate percentage 
      #percent_attrtion <- (count_attrition / tmp_count$freq[val])
      percent_attrtion <- (count_attrition / sum(tmp_count$freq))
      # Now lets make the change to the data to replace the data frame 
      df[col] <- replace(df[col], df[col]==tmp_count$x[val], percent_attrtion)
    }
  }
  return(df)
}

InvertPercentage <- function(x) { 
  # Invert percentage to standardize relationship between cat and cont dataframes
  res <- (1 - x)
  return(res)
}

PrepareData <- function(df) {
  # Function to apply the same normaliztion methods to data that has attrition and 
  # for the data that does not have attrition 
  df_pd <- df
  # Remove data that provides no statistical value 
  df_pd <- subset(df_pd, select=-c(EmployeeCount, EmployeeNumber, Over18, StandardHours))
  # Removing additional data due to correlation data 
  df_pd <- subset(df_pd, select=-c(HourlyRate, MonthlyRate, PercentSalaryHike, Education,
                                   PerformanceRating, RelationshipSatisfaction))
  # Transform all Numeric Categoires as.numeric()
  # Transform all Categorical data that has a number as.factor()
  df_pd <- transform(df_pd, 
                     Age=as.numeric(Age),
                     BusinessTravel=as.factor(BusinessTravel), DailyRate=as.numeric(DailyRate),
                     Department=as.factor(Department), DistanceFromHome=as.numeric(DistanceFromHome),
                     EducationField=as.factor(EducationField), 
                     EnvironmentSatisfaction=as.factor(EnvironmentSatisfaction),
                     Gender=as.factor(Gender), JobInvolvement=as.factor(JobInvolvement),
                     JobLevel=as.factor(JobLevel), JobRole=as.factor(JobRole),
                     JobSatisfaction=as.factor(JobSatisfaction), 
                     MaritalStatus=as.factor(MaritalStatus),
                     MonthlyIncome=as.numeric(MonthlyIncome), 
                     NumCompaniesWorked=as.numeric(NumCompaniesWorked),
                     OverTime=as.factor(OverTime), StockOptionLevel=as.factor(StockOptionLevel),
                     TotalWorkingYears=as.numeric(TotalWorkingYears),
                     TrainingTimesLastYear=as.numeric(TrainingTimesLastYear),
                     WorkLifeBalance=as.factor(WorkLifeBalance),
                     YearsAtCompany=as.numeric(YearsAtCompany),
                     YearsInCurrentRole=as.numeric(YearsInCurrentRole),
                     YearsSinceLastPromotion=as.numeric(YearsSinceLastPromotion),
                     YearsWithCurrManager=as.numeric(YearsWithCurrManager)
                     )
  
  # In case the data does not have the "Attrition" Column
  if("Attrition" %in% names(df_pd)) {
    df_pd <- transform(df_pd, Attrition=as.factor(Attrition)) 
  } 
    
  return(df_pd)
}

ConvertCatToNum <- function(df) {
  # Convert Categorical Variables to numerical, but as.factor()
  df_cctm <- df
  # Attrition
    # In case the data does not have the "Attrition" Column
  if("Attrition" %in% names(df_cctm)) {
    df_cctm$Attrition[df_cctm$Attrition=="No"] <- 0
    df_cctm$Attrition[df_cctm$Attrition=="Yes"] <- 1
  } 
  # Business Travel
  df_cctm$BusinessTravel[df_cctm$BusinessTravel=="Non-Travel"] <- 1
  df_cctm$BusinessTravel[df_cctm$BusinessTravel=="Travel_Rarely"] <- 2
  df_cctm$BusinessTravel[df_cctm$BusinessTravel=="Travel_Frequently"] <- 3
  # Employee Dept
  df_cctm$Department[df_cctm$Department=="Human Resources"] <- 1
  df_cctm$Department[df_cctm$Department=="Research & Development"] <- 2
  df_cctm$Department[df_cctm$Department=="Sales"] <- 3
  # Education Field
  df_cctm$EducationField[df_cctm$EducationField=="Human Resources"] <- 1
  df_cctm$EducationField[df_cctm$EducationField=="Life Sciences"] <- 2
  df_cctm$EducationField[df_cctm$EducationField=="Marketing"] <- 3
  df_cctm$EducationField[df_cctm$EducationField=="Medical"] <- 4
  df_cctm$EducationField[df_cctm$EducationField=="Technical Degree"] <- 5
  df_cctm$EducationField[df_cctm$EducationField=="Other"] <- 6
  # Gender 
  df_cctm$Gender[df_cctm$Gender=="Male"] <- 1
  df_cctm$Gender[df_cctm$Gender=="Female"] <- 2
  # Job Role
  df_cctm$JobRole[df_cctm$JobRole=="Healthcare Representative"] <- 1
  df_cctm$JobRole[df_cctm$JobRole=="Human Resources"] <- 2
  df_cctm$JobRole[df_cctm$JobRole=="Laboratory Technician"] <- 3
  df_cctm$JobRole[df_cctm$JobRole=="Manager"] <- 4
  df_cctm$JobRole[df_cctm$JobRole=="Manufacturing Director"] <- 5
  df_cctm$JobRole[df_cctm$JobRole=="Research Director"] <- 6
  df_cctm$JobRole[df_cctm$JobRole=="Research Scientist"] <- 7
  df_cctm$JobRole[df_cctm$JobRole=="Sales Executive"] <- 8
  df_cctm$JobRole[df_cctm$JobRole=="Sales Representative"] <- 9
  # Marital Status 
  df_cctm$MaritalStatus[df_cctm$MaritalStatus=="Single"] <- 1
  df_cctm$MaritalStatus[df_cctm$MaritalStatus=="Married"] <- 2
  df_cctm$MaritalStatus[df_cctm$MaritalStatus=="Divorced"] <- 3
  # Overtime
  df_cctm$OverTime[df_cctm$OverTime=="Yes"] <- 1
  df_cctm$OverTime[df_cctm$OverTime=="No"] <- 0
  
  return(df_cctm)
}
```

# Use linear regression model to predict salary for the data set with no salary
```{r class.source = 'fold-show'}
# Columns that could be used to determine MonthlyIncome[20]
# DailyRate[5], Education[8], Gender[13] "unfortuantly prob a factor", HourlyRate[9], 
# JobInvolvement[10], JobLevel[11], MonthlyRate[21], TotalWorkingYears[30], YearsAtCompany[33],
# YearsInCurrentRole[34]

# Create DataFrame 
income_pred_data <- subset(comp_set, select = c(MonthlyIncome, DailyRate, Education, Gender, HourlyRate,
                                       JobInvolvement, JobLevel, MonthlyRate, TotalWorkingYears,
                                       YearsAtCompany, YearsInCurrentRole))
# Replace Gender with 0 and 1
income_pred_data$Gender <- replace(income_pred_data$Gender, income_pred_data$Gender=="Male", 0)
income_pred_data$Gender <- replace(income_pred_data$Gender, income_pred_data$Gender=="Female", 1)

# Create a normalized version to create correlation table 
income_pred_data <- as.data.frame(lapply(income_pred_data, as.numeric))
income_pred_data_norm <- as.data.frame(lapply(income_pred_data[c(2:11)], min_max_norm))
income_pred_data_norm$MonthlyIncome <- income_pred_data$MonthlyIncome

# Plot Correlation 
income_pred_data_cor <- cor(income_pred_data_norm)
corrplot(income_pred_data_cor, title="Salary Correlation", mar=c(0,0,1,0))

# Based on the chart these are the categories that provide little to no-impact
# DailyRate, HourlyRate, and JobInvolvement(little surprisng)

# Create formula outside of the model creation because it can't pick up the Env
pred_fx <- as.formula(MonthlyIncome ~ JobLevel + TotalWorkingYears + YearsAtCompany + 
                       YearsInCurrentRole + Education + MonthlyRate + Gender)

# Creating this Linear model 
income_pred_data_model <- lm(pred_fx, data=income_pred_data_norm)

# Print out summary of our model
summary(income_pred_data_model)

# Print out confidence interval of model
confint(income_pred_data_model, conf.level=0.95)

# Create a prediction using original normalized data 
prediction <- as.data.frame(predict(income_pred_data_model, newdata=income_pred_data_norm))
colnames(prediction) <-c("MonthlyIncome")

# Create data frame to compare original data to the results 
compare_predictions <- data.frame(Original=income_pred_data_norm$MonthlyIncome, 
                                  Predicted=prediction$MonthlyIncome)

# Create column with difference in percentage
compare_predictions$PercentDifference <- with(compare_predictions, 
                                              abs((Original-Predicted)/(Original+Predicted)))

# Print summary of results 
summary(compare_predictions$PercentDifference)
# On average my model predicts Monthly Income with a mean difference of 9%
# and a median of 7%. Besides a couple high max values this model isn't bad.

# Change compare_preduictions$original to a numeric to work with rmse()
compare_predictions$Predicted <- as.numeric(compare_predictions$Predicted)

# Generate the ROOT MEAN SQUARE (RMSE)
pred_rsme <- sqrt(mean((compare_predictions$Original - compare_predictions$Predicted)^2))
paste("The RMSE = ", as.character(pred_rsme), sep=' ')

# Now lets apply this model to predict to income for the no_salary_data
# Create data frame to temporarly use 
emp_salary_predict <- subset(comp_set_no_salary, select=c(JobLevel, TotalWorkingYears, YearsAtCompany, 
                        YearsInCurrentRole,Education, MonthlyRate, Gender))
# "Normalize" the data 
# Assign Gender a 1 or 0
emp_salary_predict$Gender <- replace(emp_salary_predict$Gender, emp_salary_predict$Gender=="Male", 0)
emp_salary_predict$Gender <- replace(emp_salary_predict$Gender, emp_salary_predict$Gender=="Female", 1)
# Changes columns to numeric
emp_salary_predict <- as.data.frame(lapply(emp_salary_predict, as.numeric))
# Apply normalization function to data 
emp_salary_predict <- as.data.frame(lapply(emp_salary_predict[1:7], min_max_norm))
# Create data frame with predictions 
no_salary_prediction <- as.data.frame(predict(income_pred_data_model, newdata=emp_salary_predict))
# Rename column to make it easier to merge back in 
colnames(no_salary_prediction) <-c("MonthlyIncome")

# Add the new column back to the no_salary data 
comp_set_no_salary$MonthlyIncome <- no_salary_prediction$MonthlyIncome
```

# Combine Data Sets for Analysis 
```{r class.source = 'fold-show'}
# Create data frame from the two datasets the provide "attrition"
emp_data <- full_join(comp_set, comp_set_no_salary)
```

# Split Data for Attrtion EDA
```{r class.source = 'fold-show'}
# Split data into two sets for Attrition=Yes, or Attrition=No
emp_data_attr_yes <- filter(emp_data, emp_data$Attrition=="Yes")
emp_data_attr_no <- filter(emp_data, emp_data$Attrition=="No")
```

# Start EDA
#### Categorical Variables
Attrition, Business Travel, Department, 'Education, EducationField, Gender,
'JobInvolvement, 'JobLevel, JobRole, 'JobSatisfaction, MaritalStatus, 
Over18, OverTime, 'PerformanceRating, RelationshipSatisfaction, 
'WorkLifeBalance

#### Constant Variables
Age, Daily Rate, DistanceFromHome, EnvironmentSatisfaction, HourlyRate,
MonthlyIncome, MonthlyRate, NumCompaniesWorked, PercentSalaryHike, StockOptions, 
TotalWorkingYears, TrainingTimesLastYear, YearsAtCompany,YearsInCurrentRole, 
YearsSinceLastPromotion, YearsWithCurrentManager

#### Suspected Non-Factors
ID, EmployeeCount, EmployeeNumber, StandardHours(They all seem to be 80)

# Create Charts to find variables that could carry a more significant weight
### Click "Code" on the right to show code behind charts -->
```{r, figures-side, fig.show="hold", out.width="50%"}
# Compare variables by Comparing the average of all employees data-set to the
# average of emplyoees with No attrition and those with attrition

# I could have writted a function to do all this but I wanted to add subtitles 
# into the some of the charts 

# Age 
age_den <- data.frame(age=emp_data$Age, type="All_Employees")
age_den <- rbind(age_den, data.frame(age=emp_data_attr_no$Age, type="No_Attrition"))
age_den <- rbind(age_den, data.frame(age=emp_data_attr_yes$Age, type="Attrition"))
# Plot Age
ggplot(age_den, aes(x=age, fill=type)) + geom_density(alpha=0.5) + ggtitle("Age") +
  labs(subtitle = "Mean: All Employees=36.68 | No Attrition=37.34 | Attrition=33.79")

# Daily_Rate
daily_rate_den <- data.frame(DailyRate=emp_data$DailyRate, type="All_Employees")
daily_rate_den <- rbind(daily_rate_den, data.frame(DailyRate=emp_data_attr_no$DailyRate, type="No_Attrition"))
daily_rate_den <- rbind(daily_rate_den, data.frame(DailyRate=emp_data_attr_yes$DailyRate, type="Attrition"))
# Plot Daily Rate 
ggplot(daily_rate_den, aes(x=DailyRate, fill=type)) + geom_density(alpha=0.5) + ggtitle("Daily Rate") +
  labs(subtitle = "Mean: All-Employees=807.02 | No_Attrition=816.80 | Attrition=756.91")

# Business Travel
buss_travl_den <- data.frame(Travel=emp_data_attr_no$BusinessTravel, type="No_Attrition")
buss_travl_den <- rbind(buss_travl_den, 
                        data.frame(Travel=emp_data_attr_yes$BusinessTravel, type="Attrition"))
# Plot Business Travel
ggplot(buss_travl_den, aes(x=Travel, fill=type)) + geom_bar(position="dodge") + ggtitle("Business Travel") +
    geom_text(aes(label=..count..), position = position_dodge(.9), stat = "count", vjust = -.2)

# Department
dept_den <- data.frame(dept=emp_data_attr_no$Department, type="No_Attrition")
dept_den <- rbind(dept_den, data.frame(dept=emp_data_attr_yes$Department, type="Attrition"))
# Plot Department Attrition vs No_Attrition
ggplot(dept_den, aes(x=dept, fill=type)) + geom_bar(position="dodge") + ggtitle("Employee Department") +
  geom_text(aes(label=..count..), position = position_dodge(.9), stat = "count", vjust = -.2)

# Distance from Home 
dist_home_den <- data.frame(dist=emp_data$DistanceFromHome, type="All_Employees")
dist_home_den <- rbind(dist_home_den, data.frame(dist=emp_data_attr_no$DistanceFromHome, type="No_Attrition"))
dist_home_den <- rbind(dist_home_den, data.frame(dist=emp_data_attr_yes$DistanceFromHome, type="Attrition"))
# plot Distance from home 
ggplot(dist_home_den, aes(x=dist, fill=type)) + geom_density(alpha=0.5) + ggtitle("Distance From Home") +
  labs(subtitle = "Mean: All-Employees=9.17 | No Attrition=8.86 | Attrition=10.74")

# Education (level 1-4)
edu_lvl_den <- data.frame(edu_lvl=emp_data_attr_no$Education, type="No_Attrition")
edu_lvl_den <- rbind(edu_lvl_den, data.frame(edu_lvl=emp_data_attr_yes$Education, type="Attrition"))
# Plot Education Level
ggplot(edu_lvl_den, aes(x=edu_lvl, fill=type)) + geom_bar(position="dodge") + 
  ggtitle("Education Level") + xlab("Level of Education") +
  geom_text(aes(label=..count..), position = position_dodge(.9), stat = "count", vjust = -.2)

# Education Field
edu_field_den <- data.frame(edu_field=emp_data_attr_no$EducationField, type="No_Attrition")
edu_field_den <- rbind(edu_field_den, data.frame(edu_field=emp_data_attr_yes$EducationField, type="Attrition"))
# Plot Education Field
ggplot(edu_field_den, aes(x=edu_field, fill=type)) + geom_bar(position="dodge") + 
  ggtitle("Education Field") + xlab("Field of Education") +
  geom_text(aes(label=..count..), position = position_dodge(.9), stat = "count", vjust = -.2)

# Environment Satisfaction
env_stsfctn_den <- data.frame(env_stsfctn=emp_data_attr_no$EnvironmentSatisfaction, 
                              type="No_Attrition")
env_stsfctn_den <- rbind(env_stsfctn_den, data.frame(env_stsfctn=emp_data_attr_yes$EnvironmentSatisfaction, 
                                                     type="Attrition"))
# Plot Env Satisfaction
ggplot(env_stsfctn_den, aes(x=env_stsfctn, fill=type)) + geom_bar(position="dodge") + 
  ggtitle("Environment Satisfaction") + xlab("Env Satisfaction") +
  geom_text(aes(label=..count..), position = position_dodge(.9), stat = "count", vjust = -.2)

# gender
gender_den <- data.frame(gender=emp_data_attr_no$Gender, type="No_Attrition")
gender_den <- rbind(gender_den, data.frame(gender=emp_data_attr_yes$Gender, type="Attrition"))
# Plot gender
ggplot(gender_den, aes(x=gender, fill=type)) + geom_bar(position="dodge") + 
  ggtitle("Gender") + xlab("Gender") +
  geom_text(aes(label=..count..), position = position_dodge(.9), stat = "count", vjust = -.2)

# Hourly Rate 
hr_rate_den <- data.frame(hr_rate=emp_data_attr_no$HourlyRate, type="No_Attrition")
hr_rate_den <- rbind(hr_rate_den, data.frame(hr_rate=emp_data_attr_yes$HourlyRate, type="Attrition"))
# plot Hourly Rate  -> Not sure this variable will be as usefull
ggplot(hr_rate_den, aes(x=hr_rate, fill=type)) + geom_density(alpha=0.5) + ggtitle("Hourly Rate") +
  labs(subtitle = "Mean: No Attrition=65.70 | Attrition=66.55")

# Job Involvement 
job_involve_den <- data.frame(job_involve=emp_data_attr_no$JobInvolvement, type="No_Attrition")
job_involve_den <- rbind(job_involve_den, data.frame(job_involve=emp_data_attr_yes$JobInvolvement, 
                                                     type="Attrition"))
# Plot Job Involvment 
ggplot(job_involve_den, aes(x=job_involve, fill=type)) + geom_bar(position="dodge") + 
  ggtitle("Job Involvement") + xlab("job_involvement") +
  geom_text(aes(label=..count..), position = position_dodge(.9), stat = "count", vjust = -.2)

# Job Level 
job_lvl_den <- data.frame(job_lvl=emp_data_attr_no$JobLevel, type="No_Attrition")
job_lvl_den <- rbind(job_lvl_den, data.frame(job_lvl=emp_data_attr_yes$JobLevel, type="Attrition"))
# Plot Job Level
ggplot(job_lvl_den, aes(x=job_lvl, fill=type)) + geom_bar(position="dodge") + 
  ggtitle("Job Level") + xlab("Job Level") +
  geom_text(aes(label=..count..), position = position_dodge(.9), stat = "count", vjust = -.2)

# Job Role
job_role_den <- data.frame(job_role=emp_data_attr_no$JobRole, type="No_Attrition")
job_role_den <- rbind(job_role_den, data.frame(job_role=emp_data_attr_yes$JobRole, type="Attrition"))
# Plot Job Role
ggplot(job_role_den, aes(x=job_role, fill=type)) + geom_bar(position="dodge") + 
  ggtitle("Job Role") + xlab("Job Role") +
  geom_text(aes(label=..count..), position = position_dodge(.9), stat = "count", vjust = -.2) +
  theme(axis.text.x = element_text(angle = 90, size = 5))

# Job Satisfation
job_sat_den <- data.frame(job_sat=emp_data_attr_no$JobSatisfaction, type="No_Attrition")
job_sat_den <- rbind(job_sat_den, data.frame(job_sat=emp_data_attr_yes$JobSatisfaction, type="Attrition"))
# Plot Satisfaction
ggplot(job_sat_den, aes(x=job_sat, fill=type)) + geom_bar(position="dodge") + 
  ggtitle("Job Satisfaction") + xlab("Job Satisfaction") +
  geom_text(aes(label=..count..), position = position_dodge(.9), stat = "count", vjust = -.2)

# Marital Status
marital_stat_den <- data.frame(marital_stat=emp_data_attr_no$MaritalStatus, type="No_Attrition")
marital_stat_den <- rbind(marital_stat_den, data.frame(marital_stat=emp_data_attr_yes$MaritalStatus,
                                                       type="Attrition"))
# Marital Status 
ggplot(marital_stat_den, aes(x=marital_stat, fill=type)) + geom_bar(position="dodge") + 
  ggtitle("Marital Status") + xlab("Marital Status") +
  geom_text(aes(label=..count..), position = position_dodge(.9), stat = "count", vjust = -.2)

# Monthly Rate 
mnth_rate_den <- data.frame(mnth_rate=emp_data_attr_no$MonthlyRate, type="No_Attrition")
mnth_rate_den <- rbind(mnth_rate_den, data.frame(mnth_rate=emp_data_attr_yes$MonthlyRate, type="Attrition"))
# plot Monthly Rate 
ggplot(mnth_rate_den, aes(x=mnth_rate, fill=type)) + geom_density(alpha=0.5) + ggtitle("Monthly Rate") +
  labs(subtitle = "Mean: No Attrition=14274.31 | Attrition=14219.31")

# Number of Companies Worked for 
num_of_comp_den <- data.frame(num_of_comp=emp_data_attr_no$NumCompaniesWorked, type="No_Attrition")
num_of_comp_den <- rbind(num_of_comp_den, data.frame(num_of_comp=emp_data_attr_yes$NumCompaniesWorked,
                                                       type="Attrition"))
# Plot number of companies worked for 
ggplot(num_of_comp_den, aes(x=num_of_comp, fill=type)) + geom_bar(position="dodge") + 
  ggtitle("Number of Companies Worked for") + xlab("Number of Companies Worked for") +
  geom_text(aes(label=..count..), position = position_dodge(.9), stat = "count", vjust = -.2) 

# Overtime
ot_den <- data.frame(ot=emp_data_attr_no$OverTime, type="No_Attrition")
ot_den <- rbind(ot_den, data.frame(ot=emp_data_attr_yes$OverTime, type="Attrition"))
# Plot Overtime 
ggplot(ot_den, aes(x=ot, fill=type)) + geom_bar(position="dodge") + 
  ggtitle("Overtime") + xlab("Overtime") +
  geom_text(aes(label=..count..), position = position_dodge(.9), stat = "count", vjust = -.2)

# Percentage of Salary Hike 
slry_hike_den <- data.frame(slry_hike=emp_data_attr_no$PercentSalaryHike, type="No_Attrition")
slry_hike_den <- rbind(slry_hike_den, data.frame(slry_hike=emp_data_attr_yes$PercentSalaryHike, 
                                                 type="Attrition"))
# plot Percentage of Salary Hike ## Not as impactfull as I thought  
ggplot(slry_hike_den, aes(x=slry_hike, fill=type)) + geom_density(alpha=0.5) + 
  ggtitle("Percentage Salary Increase") +
  labs(subtitle = "Mean: No Attrition=15.23 | Attrition=15.14")

# Relationship Satisfaction (With manager??)
rel_satfctn_den <- data.frame(rel_satfct=emp_data_attr_no$RelationshipSatisfaction, type="No_Attrition")
rel_satfctn_den <- rbind(rel_satfctn_den, data.frame(rel_satfct=emp_data_attr_yes$RelationshipSatisfaction, 
                                                     type="Attrition"))
# Plot Relationship Satisfaction 
ggplot(rel_satfctn_den, aes(x=rel_satfct, fill=type)) + geom_bar(position="dodge") + 
  ggtitle("Relationship Satisfaction") + xlab("Relationship Satisfaction") +
  geom_text(aes(label=..count..), position = position_dodge(.9), stat = "count", vjust = -.2)

# StockOptionLevel
stck_opt_den <- data.frame(stck_opt=emp_data_attr_no$StockOptionLevel, type="No_Attrition")
stck_opt_den <- rbind(stck_opt_den, data.frame(stck_opt=emp_data_attr_yes$StockOptionLevel, 
                                                     type="Attrition"))
# Plot StockOptionLevel
ggplot(stck_opt_den, aes(x=stck_opt, fill=type)) + geom_bar(position="dodge") + 
  ggtitle("Stock Option Level") + xlab("StockOptionLevel") +
  geom_text(aes(label=..count..), position = position_dodge(.9), stat = "count", vjust = -.2)

# Total Working Years 
ttl_wrk_yrs_den <- data.frame(ttl_wrk_yrs=emp_data_attr_no$TotalWorkingYears, type="No_Attrition")
ttl_wrk_yrs_den <- rbind(ttl_wrk_yrs_den, data.frame(ttl_wrk_yrs=emp_data_attr_yes$TotalWorkingYears, 
                                                 type="Attrition"))
# plot Total working years   
ggplot(ttl_wrk_yrs_den, aes(x=ttl_wrk_yrs, fill=type)) + geom_density(alpha=0.5) + 
  ggtitle("Total Working Years") +
  labs(subtitle = "Mean: No Attrition=11.46 | Attrition=8.49")

# Training Times Last Year 
train_time_den <- data.frame(train_time=emp_data_attr_no$TrainingTimesLastYear, type="No_Attrition")
train_time_den <- rbind(train_time_den, data.frame(train_time=emp_data_attr_yes$TrainingTimesLastYear, 
                                                     type="Attrition"))
# Plot Training Times Last Year
ggplot(train_time_den, aes(x=train_time, fill=type)) + geom_bar(position="dodge") + 
  ggtitle("Last Years Training Times") + xlab("TrainingTimesLastYear") +
  geom_text(aes(label=..count..), position = position_dodge(.9), stat = "count", vjust = -.2)

# Work Life Balance 
wrk_life_den <- data.frame(wrk_life=emp_data_attr_no$WorkLifeBalance, type="No_Attrition")
wrk_life_den <- rbind(wrk_life_den, data.frame(wrk_life=emp_data_attr_yes$WorkLifeBalance, 
                                                     type="Attrition"))
# Plot Work Life Balance 
ggplot(wrk_life_den, aes(x=wrk_life, fill=type)) + geom_bar(position="dodge") + 
  ggtitle("Work Life Balance") + xlab("Work Life Balance") +
  geom_text(aes(label=..count..), position = position_dodge(.9), stat = "count", vjust = -.2)

# Years At Company 
yrs_at_comp_den <- data.frame(yrs_at_comp=emp_data_attr_no$YearsAtCompany, type="No_Attrition")
yrs_at_comp_den <- rbind(yrs_at_comp_den, data.frame(yrs_at_comp=emp_data_attr_yes$YearsAtCompany, 
                                                     type="Attrition"))
# Plot Years At Company  
ggplot(yrs_at_comp_den, aes(x=yrs_at_comp, fill=type)) + geom_density(alpha=0.5) + 
  ggtitle("Years at company") +
  labs(subtitle = "Mean: No Attrition=7.19 | Attrition=5.21")

# Years in current role
yrs_in_role_den <- data.frame(yrs_in_role=emp_data_attr_no$YearsInCurrentRole, type="No_Attrition")
yrs_in_role_den <- rbind(yrs_in_role_den, data.frame(yrs_in_role=emp_data_attr_yes$YearsInCurrentRole, 
                                                     type="Attrition"))
# Plot Years in current role  
ggplot(yrs_in_role_den, aes(x=yrs_in_role, fill=type)) + geom_density(alpha=0.5) + 
  ggtitle("Years in current role") +
  labs(subtitle = "Mean: No Attrition=4.46 | Attrition=2.85")

# years since last promotion
last_prmtn_den <- data.frame(last_prmtn=emp_data_attr_no$YearsSinceLastPromotion, type="No_Attrition")
last_prmtn_den <- rbind(last_prmtn_den, 
                        data.frame(last_prmtn=emp_data_attr_yes$YearsSinceLastPromotion, type="Attrition"))
# Plot Years since last promotion  
ggplot(last_prmtn_den, aes(x=last_prmtn, fill=type)) + geom_boxplot() + 
  ggtitle("Years since last promotion")

# Years with current manager 
yrs_cur_mngr_den <- data.frame(yrs_cur_mngr=emp_data_attr_no$YearsWithCurrManager, type="No_Attrition")
yrs_cur_mngr_den <- rbind(yrs_cur_mngr_den, 
                          data.frame(yrs_cur_mngr=emp_data_attr_yes$YearsWithCurrManager, 
                                                     type="Attrition"))
# Plot Years with current manager   
ggplot(yrs_cur_mngr_den, aes(x=yrs_cur_mngr, fill=type)) + geom_density(alpha=0.5) + 
  ggtitle("Years with current manager") +
  labs(subtitle = "Mean: No Attrition=4.29 | Attrition=2.83")

 
# Years with current manager 
monthly_inc_den <- data.frame(monthly_inc=emp_data_attr_no$MonthlyIncome, type="No_Attrition")
monthly_inc_den <- rbind(monthly_inc_den, 
                          data.frame(monthly_inc=emp_data_attr_yes$MonthlyIncome, type="Attrition"))
# Plot Monthly Income                                        
ggplot(monthly_inc_den, aes(x=monthly_inc, fill=type)) + geom_density(alpha=0.5) + 
  ggtitle("Monthly Income") +
  labs(subtitle = "Mean: No Attrition=6630.38 | Attrition=4844.37")
```

# Notes from Initial Variables 
+ All percentags are for those who have Attrition 

### Age
+ Mean -> Attrition: 33.79 | No-Attrition: 37.34 
+ The age of employees is notably younger 

### Daily Rate 
+ Mean -> Attrition: 756.91, No-Attrition: 816.80 
+ The daily rate is lower for those with attrition

### Business Travel 
+ Non-Travel: 9.3% 
+ Travel-Frequently: 24.54% 
+ Travel-Rarely: 15.14% 
+ Seems those who have to travel frequently have a more likelyhood of attrition

### Employee Department 
+ HR: 17.3% 
+ R&D: 14.23%
+ Sales: 20.49%
+ Those in Sales and HR have a little higher attrition rate

### Distance from Home
+ Mean -> Attrition: 10.74 | No-Attrition: 8.86
+ Those who lived closer to work had a lower chance of Attrition
+ A majority of those with no attrition lived within 5 miles 

### Education Level
+ 1: 18.84%
+ 2: 18.03%
+ 3: 16.33%
+ 4: 14.60%
+ 5: 10.81%
+ These all seem to fall in line with eachother 
+ The only difference is the level 5 education with a small sample size
+ Not sure this values carries a big enough wieght to be used effectively

### Education Field 
+ HR: 25%
+ Life Science: 15% 
+ Marketing: 19.7%
+ Medical: 14.86%
+ Other: 14.29%
+ Technical Degree: 22.55
+ Seems HR, Marketing, and Tech Degrees have the most with with attrition

### Environment Satisfaction 
+ 1: 25.88%
+ 2: 14.29%
+ 3: 14.16%
+ 4: 13.69%
+ As Env satisfaction goes up, attrition goes down (No Surprise there)

### Gender 
+ Male: 8.94% 
+ Female: 17.61%
+ Looks like females have more attrition
+ Any reason why? Could be based on other factors? 

### Hourly Rate 
+ Mean -> Attrition: 66.55 | No-Attrition: 65.70
+ Looking at the chart doesn't reveal much
+ Potentially not going to use this data

### Job Involvement 
+ 1: 39.68%
+ 2: 19.14%
+ 3: 14.1%
+ 4: 9.17%
+ This is a heavy weight! Low job involvement is something to look at 

### Job Level 
+ 1: 26.32%
+ 2: 9.53%
+ 3: 14.36%
+ 4: 5.26%
+ 5: 10.87%
+ Levels 3 and 5 have a higher rate, but level 1 stands above the rest 

### Job Role 
+ Healthcare Rep: 7.84%
+ HR: 20.45%
+ Lab Tech: 22.55%
+ Manager: 6.94%
+ Manufacturing Dir: 7.02%
+ Research Dir: 3.23%
+ Research Scientist: 17.32%
+ Sales Exec: 15.99%
+ Sales Rep: 41.66%
+ Highest attrition goes to Sales Rep with a whopping 41.66% attrition
+ Honorable mentions go to HR, Lab Techs, Research Scientest, and \
sales execs

### Job Satisfaction
+ 1: 22.03%
+ 2: 16.74%
+ 3: 17.48%
+ 4: 11.26%
+ Slight up-tick when the job satisfaction is at a 1

### Marital Status 
+ Divorced: 9.16%
+ Married: 13.21%
+ Single: 26.17%
+ Personal opinion leads me to think that the reason Single employees have a \
higher attrition could be due having the flexibility of switching careers \
without having to be restricted (respectively) by family. 

### Monthly Rate
+ Mean -> Attrition: 14274.31 | No-Attrition: 14274.31
+ This more or less follows the Hourly rate patteren and I fail to see why \
this should be included for analysis when we have other wage info
+ What is the rate even representitive of; productivity, money??

### Number of Companies Worked for before
+ 0: 11.5%, 1: 18.4%, 2: 12.5%, 3: 10.32%, 4: 10.91%, 5: 24.1%, 6: 25.9%, \
7: 23.8%, 8: 12.5%, 9: 25.0%
+ Noticable increase in attrition as employees have more previous jobs

### Overtime 
+ No: 10.1%
+ Yes: 32.32%
+ Big increase in Attrition when overtime is involved 

### Percentage Salary Increase 
+ Mean-> Attrition: 15.14 | No-Attrition: 15.23
+ While the means are roughly the same the density chart shows a heavy right \
skew and where the salary hike is less than 15% the attrition is much higher

### Relationship Satisfaction 
+ 1: 20.52%
+ 2: 15.66%
+ 3: 14.33%
+ 4: 16.03%
+ Not the biggest contribution, but enough to provide a push towards attrition

### Stock Option Level
+ 0: 25.2%
+ 1: 9.5%
+ 2: 5.7%
+ 3: 19.12%
+ I'm not sure what to make of this, but I will assume that young employees \
aren't eligable to get stock option. Could be very expensive to offer though.

### Total Working Years
+ Mean-> Attrition: 8.49 | No-Attrition: 11.46 

### Percentage Salary Increases 
+ Mean-> Attrition: 15.14 | No-Attrition: 15.23

### Training time from last year
+ 0: 21.4%, 1: 12.7%, 2: 19.0%, 3: 13.7%, 4: 22.68%, 5: 13.1%, 6: 9.6%
+ Data doesn't seem to be too specific 
+ I would like to test the training times of new (>2years) emlpoyees 

### Work life Balance 
+ 1: 31.8%
+ 2: 16.5%
+ 3: 14.9%
+ 4: 16.13%
+ Again not really a surprise 

### Years at company 
+ Mean-> Attrition: 5.21 | No-Attrition: 7.19
+ Attrition really spikes with years less that 7

### Years in Current Role
+ Mean-> Attrition: 2.85 | No-Attrition: 4.46
+ Much like the "years at company" it follows the same pattern
+ Although big drop off after 5 years, small spike at 7 and drop off again

### Years since last promotion
+ The mean of the two stayed releativly the same, but attrition seemed to \
stay in the 0-2 range 

### Years with Current Manager 
+ Mean-> Attrition: 2.83 | No-Attrition: 4.29
+ Follows some pattern as other time based charts

### Monthly Income
+ Mean-> Attrition: 4,844.37 | No-Attrition: 6,630.38 
+ Those with attrition has a much lower income

# Clean-Up Data 
```{r class.source = 'fold-show'}
## Cleanup some variables to free space and clutter 
rm(list=c("age_den", "daily_rate_den", "buss_travl_den", "dept_den", 
          "dist_home_den", "edu_lvl_den", "edu_field_den", "env_stsfctn_den",
          "gender_den", "hr_rate_den", "job_involve_den", "job_lvl_den", 
          "job_role_den", "job_sat_den", "marital_stat_den", "mnth_rate_den",
          "num_of_comp_den", "ot_den", "slry_hike_den", "rel_satfctn_den", 
          "stck_opt_den", "ttl_wrk_yrs_den", "train_time_den", "wrk_life_den",
          "yrs_at_comp_den", "yrs_in_role_den", "last_prmtn_den", 
          "yrs_cur_mngr_den", "monthly_inc_den"))
```

# Find Correlation to Attrition
The goal is to normalize all the data to get more accurate models
```{r class.source = 'fold-show', fig.width=10, fig.height=11}
# Remove columns that do not provide significance 
emp_data_mod <- emp_data[-c(1, 10, 11, 23, 28)]

# Create New data frame for continous data 
emp_data_mod_cont <- subset(emp_data_mod, select = c(Age, Attrition, DailyRate, DistanceFromHome, 
                                           HourlyRate,MonthlyIncome, MonthlyRate, NumCompaniesWorked, 
                                           PercentSalaryHike, TotalWorkingYears, TrainingTimesLastYear,
                                           YearsAtCompany, YearsInCurrentRole, YearsSinceLastPromotion,
                                           YearsWithCurrManager))

# Make attrition logical in emp_data_mod_cat
emp_data_mod_cont$Attrition <- replace(emp_data_mod_cont$Attrition, 
                                      emp_data_mod_cont$Attrition=="No", as.numeric(1))
emp_data_mod_cont$Attrition <- replace(emp_data_mod_cont$Attrition, 
                                      emp_data_mod_cont$Attrition=="Yes", as.numeric(0))

# Normalize 
emp_data_mod_cont <- as.data.frame(lapply(emp_data_mod_cont, as.numeric))
emp_data_mod_cont <- as.data.frame(lapply(emp_data_mod_cont, min_max_norm))

# Create correlation plot 
emp_data_mod_cont_cor <- cor(emp_data_mod_cont)
corrplot(emp_data_mod_cont_cor, method='number', title='Correlation Based on Continous Vars',
         mar=c(0,0,1,0))

# Create data frame for categorical data "Including Attrition"
emp_data_mod_cat <- subset(emp_data_mod, select=c(Attrition, BusinessTravel, Department, Education,
                                                  EducationField, EnvironmentSatisfaction, Gender, 
                                                  JobInvolvement, JobLevel, JobRole, JobSatisfaction,
                                                  MaritalStatus, OverTime, PerformanceRating, 
                                                  RelationshipSatisfaction, StockOptionLevel, 
                                                  WorkLifeBalance))
# Transform with function
emp_data_mod_cat <- CategoryToPercent(emp_data_mod_cat)

# Set attrition to 1 and 0
emp_data_mod_cat$Attrition <- replace(emp_data_mod_cat$Attrition, 
                                      emp_data_mod_cat$Attrition=="No", as.numeric(0))
emp_data_mod_cat$Attrition <- replace(emp_data_mod_cat$Attrition, 
                                      emp_data_mod_cat$Attrition=="Yes", as.numeric(1))
# Set columns to numeric if they arne't 
emp_data_mod_cat <- as.data.frame(lapply(emp_data_mod_cat, as.numeric))
emp_data_mod_cat <- as.data.frame(lapply(emp_data_mod_cat, InvertPercentage))

# Create Correlation for categorical 
emp_data_mod_cat_cor <- cor(emp_data_mod_cat)
corrplot(emp_data_mod_cat_cor, method='number', title='Correlation Based on Categorical Vars', 
         mar=c(0,0,1,0))

```

## Correlation Notes

### Categories that make the biggest difference 
+ Age, MonthlyIncome, TotalWorkingYears, YearsAtCompany, YearsInCurrentRole, \
YearsWithCurrManager, JobLevel, JobRole, MaritalStatus, OverTime, StockOptionLevel

### Categories that make the least difference 
+ HourlyRate, MonthlyRate, PercentSalaryHike, Education, PerformanceRating, \
RelationshipSatisfaction

## Top Contendors for Attrition
+ JobLevel
+ OverTime
+ StockOptionLevel
Since Changing Stock Options can be very expensive the 3rd place could be \
"YearsInCurrentRole"

# Testing KNN Models with different 
```{r class.source = 'fold-show'}
set.seed(3)
# Standardize the data the same way using a reusable data prep function I wrote
# All prep work is done in this function
knn_emp_data <- PrepareData(emp_data)

# Create empty train and test data frames 
knn_emp_data_train <- data.frame()
knn_emp_data_test <- data.frame()

# Split Data 70/30
num_samples_to_take <- round(as.numeric(nrow(knn_emp_data)*.7), digits=0)
index <- sample(seq_len(nrow(knn_emp_data)), size=num_samples_to_take)
knn_emp_data_train <- knn_emp_data[index,]
knn_emp_data_test <- knn_emp_data[-index,]

############################ KNN Model ########################################
# Formula for Nearest_Neighbor
knn_emp_formula <- as.formula(Attrition ~ Age + BusinessTravel + DailyRate + Department + 
  DistanceFromHome + EducationField + EnvironmentSatisfaction + Gender + 
  JobInvolvement + JobLevel + JobRole + JobSatisfaction + MaritalStatus +
  MonthlyIncome + NumCompaniesWorked + OverTime + StockOptionLevel + TotalWorkingYears +
  TrainingTimesLastYear + WorkLifeBalance + YearsAtCompany + YearsInCurrentRole +
  YearsSinceLastPromotion + YearsWithCurrManager)

# Define K values 
optimal_k <- 3

# Generate Model
attrition_model_2 <- nearest_neighbor(neighbors=optimal_k, weight_func="inv") %>%
  set_engine("kknn") %>%
  set_mode("classification") %>% 
  fit(formula=knn_emp_formula, data=knn_emp_data_train)

# Create prediction 
pred_grid <- attrition_model_2 %>% predict(knn_emp_data_test)
attrition_tab_2 <- table(pred_grid$.pred_class, knn_emp_data_test$Attrition)
confusionMatrix(attrition_tab_2)
#################################################################################
```
+ With many attempts at changing the k value and the formula, the best results \
I could acheive is with a 96%-Sensitivity and 30%-Specificity

# Random Forest
```{r class.source = 'fold-show'}
set.seed(4)

# Use random forest to give us a different model to compare to 
# rf = Random Forest 
rf_emp_data <- emp_data

# Convert the categorical values to numbers as factors 
rf_emp_data <- ConvertCatToNum(rf_emp_data)
# Prepare data to keep it standardized 
rf_emp_data <- PrepareData(rf_emp_data)

# Create empty train and test data frames 
rf_emp_data_train <- data.frame()
rf_emp_data_test <- data.frame()

# Split Data 70/30
num_samples_to_take <- round(as.numeric(nrow(rf_emp_data)*.7), digits=0)
index <- sample(seq_len(nrow(rf_emp_data)), size=num_samples_to_take)
rf_emp_data_train <- rf_emp_data[index,]
rf_emp_data_test <- rf_emp_data[-index,]

# Train Random Forest Model
rf_model <- randomForest(
  Attrition ~ .,
  data=rf_emp_data_train
)
# Print Model details 
rf_model

# Predict 
rf_predict <- predict(rf_model, newdata=rf_emp_data_test)
rf_predict <- as.data.frame(rf_predict)

# Create table for confusion Matrix
rf_cm <- table(rf_emp_data_test$Attrition, rf_predict$rf_predict)
confusionMatrix(rf_cm)
```

# Predict Attrition
```{r}
# Use the best model (Random Forest) to predict attrition from the provided data
# Create output CSV of the results 
emp_final_pred <- comp_set_no_attrition

# Like the training data, run the data through the same prep functions
# Convert the categorical values to numbers as factors 
emp_final_pred <- ConvertCatToNum(emp_final_pred)
# Prepare data to keep it standardized 
emp_final_pred <- PrepareData(emp_final_pred)

# Prediction Time
rf_final_pred <- predict(rf_model, newdata=emp_final_pred)
rf_predict <- as.data.frame(rf_final_pred)

# Replace 0's and 1's with no and yes 
rf_predict <- transform(rf_predict, rf_final_pred=as.character(rf_final_pred))
rf_predict$rf_final_pred[rf_predict$rf_final_pred=="0"] <- "No"
rf_predict$rf_final_pred[rf_predict$rf_final_pred=="1"] <- "Yes"

# Change Column name
colnames(rf_predict) <- c("Attrition")
count(rf_predict)

# Add back to data 
rf_predict$ID <- comp_set_no_attrition$ID
comp_set_predicted_attrition <- merge(comp_set_no_attrition, rf_predict, by="ID")

# Create DF of employees that predicted yes for attrition 
positive_attrition <- filter(comp_set_predicted_attrition, 
                               comp_set_predicted_attrition$Attrition=="Yes")

positive_attrition

# Write Results to output folder
write.csv(comp_set_predicted_attrition, "./Output/Attrition_Prediction_Results.csv")
```

# Other Interesting Information
```{r}

```







